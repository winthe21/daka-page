<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿æ˜¥åŸå¸‚å‹å¥½åœ°å›¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .stamp-shadow {
                filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
            }
            .stamp-glow {
                animation: glow 1.5s ease-in-out infinite alternate;
            }
            .float {
                animation: float 3s ease-in-out infinite;
            }
            .pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
        }
        
        @keyframes glow {
            from {
                filter: drop-shadow(0 0 5px rgba(59, 130, 246, 0.5));
            }
            to {
                filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.8));
            }
        }
        
        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-indigo-50 min-h-screen font-sans text-dark">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-map-marker text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">é•¿æ˜¥åŸå¸‚å‹å¥½åœ°å›¾</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="profileBtn" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-user-circle-o text-xl"></i>
                </button>
                <button id="helpBtn" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-question-circle-o text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- ç”¨æˆ·ä½ç½®ä¿¡æ¯ -->
        <section id="locationSection" class="bg-white rounded-xl shadow-md p-4 mb-6 transform transition-all duration-300">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold text-gray-800">å½“å‰ä½ç½®</h2>
                <button id="refreshLocation" class="text-primary text-sm flex items-center hover:underline">
                    <i class="fa fa-refresh mr-1"></i> åˆ·æ–°
                </button>
            </div>
            <div id="locationStatus" class="flex items-center justify-center py-6 text-gray-500">
                <i class="fa fa-spinner fa-spin mr-2"></i>
                <span>æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...</span>
            </div>
            <div id="locationInfo" class="hidden">
                <div class="flex items-start">
                    <i class="fa fa-map-marker text-secondary mt-1 mr-3 text-lg"></i>
                    <div>
                        <p id="locationAddress" class="font-medium"></p>
                        <p id="locationDistance" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                </div>
                <button id="checkInBtn" class="mt-4 w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg">
                    <i class="fa fa-check-circle mr-2"></i>åœ¨æ­¤åœ°ç‚¹æ‰“å¡
                </button>
            </div>
        </section>

        <!-- é™„è¿‘å¯æ‰“å¡åœ°ç‚¹ -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">é™„è¿‘å¯æ‰“å¡åœ°ç‚¹</h2>
                <span id="nearbyCount" class="bg-primary/10 text-primary text-sm px-2 py-1 rounded-full"></span>
            </div>
            
            <div id="nearbyPlaces" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- åœ°ç‚¹å¡ç‰‡ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div class="animate-pulse bg-white rounded-xl shadow-sm p-4">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-3"></div>
                    <div class="h-3 bg-gray-200 rounded w-1/2 mb-4"></div>
                    <div class="h-8 bg-gray-200 rounded w-full"></div>
                </div>
                <div class="animate-pulse bg-white rounded-xl shadow-sm p-4">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-3"></div>
                    <div class="h-3 bg-gray-200 rounded w-1/2 mb-4"></div>
                    <div class="h-8 bg-gray-200 rounded w-full"></div>
                </div>
            </div>
        </section>

        <!-- é›†ç« å±•ç¤ºåŒº -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">æˆ‘çš„å¾½ç« </h2>
                <span id="stampProgress" class="text-sm text-gray-500"></span>
            </div>
            
            <div id="stampCollection" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                <!-- å¾½ç« ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- æ‰“å¡å†å² -->
        <section class="mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ‰“å¡å†å²</h2>
            
            <div id="checkInHistory" class="space-y-3">
                <!-- å†å²è®°å½•ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div class="bg-white rounded-xl shadow-sm p-4 text-center text-gray-500">
                    æš‚æ— æ‰“å¡è®°å½•ï¼Œå¿«å»æ‰“å¡å§ï¼
                </div>
            </div>
        </section>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <footer class="bg-white border-t border-gray-200 py-4 sticky bottom-0 z-40">
        <div class="container mx-auto px-6">
            <div class="flex justify-around">
                <a href="#" class="flex flex-col items-center text-primary">
                    <i class="fa fa-home text-xl"></i>
                    <span class="text-xs mt-1">é¦–é¡µ</span>
                </a>
                <a href="#" class="flex flex-col items-center text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-compass text-xl"></i>
                    <span class="text-xs mt-1">æ¢ç´¢</span>
                </a>
                <a href="#" class="flex flex-col items-center text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-trophy text-xl"></i>
                    <span class="text-xs mt-1">æˆå°±</span>
                </a>
                <a href="#" class="flex flex-col items-center text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-info-circle text-xl"></i>
                    <span class="text-xs mt-1">å…³äº</span>
                </a>
            </div>
        </div>
    </footer>

    <!-- æ‰“å¡æˆåŠŸå¼¹çª— -->
    <div id="successModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 w-5/6 max-w-md transform transition-all">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fa fa-check text-4xl text-green-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">æ‰“å¡æˆåŠŸï¼</h3>
                <p id="successMessage" class="text-gray-600 mb-6">æ‚¨å·²æˆåŠŸåœ¨[åœ°ç‚¹åç§°]æ‰“å¡ï¼Œè·å¾—ä¸€æšæ–°å¾½ç« ï¼</p>
                <div id="newStampPreview" class="mb-6 flex justify-center">
                    <!-- æ–°è·å¾—çš„å¾½ç« é¢„è§ˆ -->
                </div>
                <button id="closeSuccessModal" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-8 rounded-lg transition-all w-full">
                    ç»§ç»­æ¢ç´¢
                </button>
            </div>
        </div>
    </div>

    <!-- å¸®åŠ©å¼¹çª— -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 w-5/6 max-w-md max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">æ´»åŠ¨å¸®åŠ©</h3>
                <button id="closeHelpModal" class="text-gray-500 hover:text-gray-800">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4 text-gray-600">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-1">å¦‚ä½•å‚ä¸æ‰“å¡ï¼Ÿ</h4>
                    <p>1. å…è®¸è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯</p>
                    <p>2. åœ¨å¯æ‰“å¡åœ°ç‚¹èŒƒå›´å†…ç‚¹å‡»"åœ¨æ­¤åœ°ç‚¹æ‰“å¡"</p>
                    <p>3. æˆåŠŸæ‰“å¡åå°†è·å¾—å¯¹åº”å¾½ç« </p>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-1">é›†é½å¾½ç« æœ‰ä»€ä¹ˆå¥–åŠ±ï¼Ÿ</h4>
                    <p>é›†é½æ‰€æœ‰å¾½ç« å¯è·å¾—ç²¾ç¾ç¤¼å“ä¸€ä»½ï¼Œè¯¦æƒ…è¯·å…³æ³¨å…¬ä¼—å·åç»­é€šçŸ¥ã€‚</p>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-1">ä¸ºä»€ä¹ˆæ— æ³•æ‰“å¡ï¼Ÿ</h4>
                    <p>è¯·ç¡®ä¿æ‚¨åœ¨æ‰“å¡åœ°ç‚¹é™„è¿‘ï¼ˆé€šå¸¸ä¸º500ç±³èŒƒå›´å†…ï¼‰ï¼Œå¹¶å·²æˆäºˆä½ç½®æƒé™ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ•°æ® - å¯æ‰“å¡åœ°ç‚¹
        const checkInPlaces = [
            { id: 1, name: "ä¸‰ç¯", address: "æ–‡åŒ–ä¸œè·¯123å·", lat: 43.8175, lng: 125.3361, stamp: "ğŸ›ï¸" },
            { id: 2, name: "æ•°å­—åˆ›æ„", address: "é•¿æ˜¥XXXX45å·", lat: 43.8145, lng: 125.3329, stamp: "ğŸŒ³" },
            { id: 3, name: "ç§‘æŠ€ä¸­å¿ƒ", address: "åˆ›æ–°è·¯789å·", lat: 39.9287, lng: 116.4175, stamp: "ğŸ”¬" },
            { id: 4, name: "è‰ºæœ¯ç”»å»Š", address: "ç¾å­¦è¡—67å·", lat: 39.8987, lng: 116.4275, stamp: "ğŸ¨" },
            { id: 5, name: "å†å²å¤è¿¹", address: "å¤åŸè·¯88å·", lat: 39.8887, lng: 116.4075, stamp: "ğŸ¯" },
            { id: 6, name: "æ»¨æ±Ÿå…¬å›­", address: "æ±Ÿæ»¨è·¯101å·", lat: 39.9087, lng: 116.3875, stamp: "ğŸš¤" },
            { id: 7, name: "æ¤ç‰©å›­", address: "å›­æ—è·¯23å·", lat: 39.9387, lng: 116.3975, stamp: "ğŸŒº" },
            { id: 8, name: "å›¾ä¹¦é¦†", address: "çŸ¥è¯†è·¯56å·", lat: 39.9187, lng: 116.4375, stamp: "ğŸ“š" }
        ];

        // åº”ç”¨çŠ¶æ€
        const appState = {
            userLocation: null,
            checkedInPlaces: JSON.parse(localStorage.getItem('checkedInPlaces')) || [],
            nearbyPlaces: []
        };

        // DOM å…ƒç´ 
        const elements = {
            locationStatus: document.getElementById('locationStatus'),
            locationInfo: document.getElementById('locationInfo'),
            locationAddress: document.getElementById('locationAddress'),
            locationDistance: document.getElementById('locationDistance'),
            checkInBtn: document.getElementById('checkInBtn'),
            refreshLocation: document.getElementById('refreshLocation'),
            nearbyPlaces: document.getElementById('nearbyPlaces'),
            nearbyCount: document.getElementById('nearbyCount'),
            stampCollection: document.getElementById('stampCollection'),
            stampProgress: document.getElementById('stampProgress'),
            checkInHistory: document.getElementById('checkInHistory'),
            successModal: document.getElementById('successModal'),
            successMessage: document.getElementById('successMessage'),
            newStampPreview: document.getElementById('newStampPreview'),
            closeSuccessModal: document.getElementById('closeSuccessModal'),
            helpBtn: document.getElementById('helpBtn'),
            helpModal: document.getElementById('helpModal'),
            closeHelpModal: document.getElementById('closeHelpModal')
        };

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // è·å–ç”¨æˆ·ä½ç½®
            getUserLocation();
            
            // æ¸²æŸ“å¾½ç« æ”¶é›†
            renderStampCollection();
            
            // æ¸²æŸ“æ‰“å¡å†å²
            renderCheckInHistory();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬
            bindEvents();
        }

        // è·å–ç”¨æˆ·ä½ç½®
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        appState.userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateLocationInfo();
                        findNearbyPlaces();
                    },
                    (error) => {
                        console.error("è·å–ä½ç½®å¤±è´¥:", error);
                        elements.locationStatus.innerHTML = `
                            <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>
                            <span>æ— æ³•è·å–ä½ç½®ï¼Œè¯·å…è®¸ä½ç½®æƒé™</span>
                        `;
                        
                        // æ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©ä½ç½®çš„é€‰é¡¹
                        const manualBtn = document.createElement('button');
                        manualBtn.className = 'mt-3 text-primary hover:underline text-sm';
                        manualBtn.innerHTML = '<i class="fa fa-map mr-1"></i> æ‰‹åŠ¨é€‰æ‹©ä½ç½®';
                        manualBtn.onclick = showManualLocationSelector;
                        elements.locationStatus.appendChild(manualBtn);
                    }
                );
            } else {
                elements.locationStatus.innerHTML = `
                    <i class="fa fa-exclamation-triangle text-amber-500 mr-2"></i>
                    <span>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒä½ç½®æœåŠ¡</span>
                `;
            }
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©ä½ç½®
        function showManualLocationSelector() {
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„ä½ç½®é€‰æ‹©å™¨
            elements.locationStatus.innerHTML = `
                <div class="w-full">
                    <p class="mb-2 text-sm text-gray-600">è¯·é€‰æ‹©æ‚¨çš„ä½ç½®ï¼š</p>
                    <select id="manualLocation" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">-- é€‰æ‹©åœ°ç‚¹ --</option>
                        ${checkInPlaces.map(place => `
                            <option value="${place.id}">${place.name} (${place.address})</option>
                        `).join('')}
                    </select>
                </div>
            `;
            
            document.getElementById('manualLocation').addEventListener('change', function(e) {
                if (e.target.value) {
                    const selectedPlace = checkInPlaces.find(p => p.id == e.target.value);
                    if (selectedPlace) {
                        appState.userLocation = {
                            lat: selectedPlace.lat,
                            lng: selectedPlace.lng,
                            manual: true
                        };
                        updateLocationInfo(selectedPlace);
                        findNearbyPlaces();
                    }
                }
            });
        }

        // æ›´æ–°ä½ç½®ä¿¡æ¯æ˜¾ç¤º
        function updateLocationInfo(manualPlace = null) {
            if (manualPlace) {
                elements.locationAddress.textContent = manualPlace.name;
                elements.locationDistance.textContent = `æ‰‹åŠ¨é€‰æ‹©çš„ä½ç½®`;
                elements.checkInBtn.dataset.placeId = manualPlace.id;
            } else {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨é€†åœ°ç†ç¼–ç APIè·å–å®é™…åœ°å€
                // ç®€åŒ–å¤„ç†ï¼Œæ‰¾åˆ°æœ€è¿‘çš„åœ°ç‚¹
                const nearestPlace = findNearestPlace();
                if (nearestPlace) {
                    const distance = calculateDistance(
                        appState.userLocation.lat, 
                        appState.userLocation.lng, 
                        nearestPlace.lat, 
                        nearestPlace.lng
                    );
                    
                    elements.locationAddress.textContent = nearestPlace.name;
                    elements.locationDistance.textContent = `è·ç¦»æ‚¨çº¦ ${distance.toFixed(0)} ç±³`;
                    elements.checkInBtn.dataset.placeId = nearestPlace.id;
                } else {
                    elements.locationAddress.textContent = `çº¬åº¦: ${appState.userLocation.lat.toFixed(6)}, ç»åº¦: ${appState.userLocation.lng.toFixed(6)}`;
                    elements.locationDistance.textContent = `æœªæ‰¾åˆ°é™„è¿‘çš„æ‰“å¡ç‚¹`;
                    elements.checkInBtn.disabled = true;
                    elements.checkInBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    elements.checkInBtn.innerHTML = '<i class="fa fa-exclamation-circle mr-2"></i>é™„è¿‘æ— æ‰“å¡ç‚¹';
                }
            }
            
            elements.locationStatus.classList.add('hidden');
            elements.locationInfo.classList.remove('hidden');
        }

        // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆç±³ï¼‰
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // è·ç¦»ï¼ˆç±³ï¼‰
        }

        // æŸ¥æ‰¾æœ€è¿‘çš„åœ°ç‚¹
        function findNearestPlace() {
            if (!appState.userLocation) return null;
            
            let nearestPlace = null;
            let minDistance = Infinity;
            
            checkInPlaces.forEach(place => {
                const distance = calculateDistance(
                    appState.userLocation.lat, 
                    appState.userLocation.lng, 
                    place.lat, 
                    place.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPlace = { ...place, distance };
                }
            });
            
            return nearestPlace;
        }

        // æŸ¥æ‰¾é™„è¿‘çš„åœ°ç‚¹ï¼ˆ500ç±³å†…ï¼‰
        function findNearbyPlaces() {
            if (!appState.userLocation) return;
            
            appState.nearbyPlaces = checkInPlaces
                .map(place => {
                    const distance = calculateDistance(
                        appState.userLocation.lat, 
                        appState.userLocation.lng, 
                        place.lat, 
                        place.lng
                    );
                    return { ...place, distance };
                })
                .filter(place => place.distance <= 1000) // 1000ç±³èŒƒå›´å†…
                .sort((a, b) => a.distance - b.distance);
            
            renderNearbyPlaces();
        }

        // æ¸²æŸ“é™„è¿‘çš„åœ°ç‚¹
        function renderNearbyPlaces() {
            elements.nearbyCount.textContent = `${appState.nearbyPlaces.length}ä¸ªåœ°ç‚¹`;
            
            if (appState.nearbyPlaces.length === 0) {
                elements.nearbyPlaces.innerHTML = `
                    <div class="col-span-full bg-white rounded-xl shadow-sm p-6 text-center text-gray-500">
                        <i class="fa fa-map-o text-3xl mb-3 text-gray-300"></i>
                        <p>é™„è¿‘1å…¬é‡Œå†…æ²¡æœ‰å¯æ‰“å¡çš„åœ°ç‚¹</p>
                    </div>
                `;
                return;
            }
            
            elements.nearbyPlaces.innerHTML = appState.nearbyPlaces.map(place => {
                const isCheckedIn = appState.checkedInPlaces.some(p => p.id === place.id);
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 transform transition-all hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold">${place.name}</h3>
                            ${isCheckedIn ? 
                                '<span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full">å·²æ‰“å¡</span>' : 
                                '<span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">å¯æ‰“å¡</span>'
                            }
                        </div>
                        <p class="text-sm text-gray-500 mt-1 mb-3">${place.address}</p>
                        <p class="text-sm text-gray-600 mb-4"><i class="fa fa-distance text-gray-400 mr-1"></i> è·ç¦»: ${place.distance.toFixed(0)} ç±³</p>
                        <button 
                            class="w-full ${isCheckedIn ? 
                                'bg-gray-200 text-gray-500 cursor-not-allowed' : 
                                'bg-primary hover:bg-primary/90 text-white hover:shadow transition-all'
                            } py-2 px-4 rounded-lg text-sm"
                            ${isCheckedIn ? 'disabled' : ''}
                            data-place-id="${place.id}"
                            ${!isCheckedIn ? 'onclick="checkInPlace(' + place.id + ')"' : ''}
                        >
                            ${isCheckedIn ? 
                                '<i class="fa fa-check-circle mr-1"></i> å·²æ‰“å¡' : 
                                '<i class="fa fa-map-marker mr-1"></i> å»æ‰“å¡'
                            }
                        </button>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“å¾½ç« æ”¶é›†
        function renderStampCollection() {
            elements.stampCollection.innerHTML = checkInPlaces.map(place => {
                const isCheckedIn = appState.checkedInPlaces.some(p => p.id === place.id);
                return `
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl mb-2 
                            ${isCheckedIn ? 'bg-primary/10 text-primary stamp-shadow' : 'bg-gray-100 text-gray-300'}
                            transition-all duration-300 transform ${isCheckedIn ? 'scale-100' : 'hover:scale-105'}">
                            ${place.stamp}
                        </div>
                        <span class="text-xs text-center text-gray-600">${place.name}</span>
                    </div>
                `;
            }).join('');
            
            // æ›´æ–°è¿›åº¦
            const progress = appState.checkedInPlaces.length;
            const total = checkInPlaces.length;
            elements.stampProgress.textContent = `${progress}/${total} æšå¾½ç« `;
        }

        // æ¸²æŸ“æ‰“å¡å†å²
        function renderCheckInHistory() {
            if (appState.checkedInPlaces.length === 0) {
                elements.checkInHistory.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center text-gray-500">
                        æš‚æ— æ‰“å¡è®°å½•ï¼Œå¿«å»æ‰“å¡å§ï¼
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
            const sortedHistory = [...appState.checkedInPlaces].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            elements.checkInHistory.innerHTML = sortedHistory.map(record => {
                const place = checkInPlaces.find(p => p.id === record.id);
                const date = new Date(record.date);
                const formattedDate = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 transform transition-all hover:shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold">${place.name}</h3>
                                <p class="text-sm text-gray-500 mt-1">${place.address}</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center text-xl">
                                ${place.stamp}
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">æ‰“å¡æ—¶é—´: ${formattedDate}</p>
                    </div>
                `;
            }).join('');
        }

        // æ‰“å¡åŠŸèƒ½
        function checkInPlace(placeId) {
            const place = checkInPlaces.find(p => p.id === placeId);
            if (!place) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“å¡
            if (appState.checkedInPlaces.some(p => p.id === placeId)) {
                alert('æ‚¨å·²ç»åœ¨è¿™ä¸ªåœ°ç‚¹æ‰“å¡è¿‡äº†ï¼');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ‰“å¡èŒƒå›´å†…ï¼ˆ500ç±³ï¼‰
            if (appState.userLocation && !appState.userLocation.manual) {
                const distance = calculateDistance(
                    appState.userLocation.lat, 
                    appState.userLocation.lng, 
                    place.lat, 
                    place.lng
                );
                
                if (distance > 500) {
                    alert(`æ‚¨è·ç¦»${place.name}å¤ªè¿œäº†ï¼ˆ${distance.toFixed(0)}ç±³ï¼‰ï¼Œè¯·é è¿‘åå†æ‰“å¡ï¼`);
                    return;
                }
            }
            
            // è®°å½•æ‰“å¡
            const checkInRecord = {
                id: placeId,
                date: new Date().toISOString()
            };
            
            appState.checkedInPlaces.push(checkInRecord);
            localStorage.setItem('checkedInPlaces', JSON.stringify(appState.checkedInPlaces));
            
            // æ›´æ–°UI
            renderStampCollection();
            renderCheckInHistory();
            renderNearbyPlaces();
            
            // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
            showSuccessModal(place);
        }

        // æ˜¾ç¤ºæ‰“å¡æˆåŠŸå¼¹çª—
        function showSuccessModal(place) {
            elements.successMessage.textContent = `æ‚¨å·²æˆåŠŸåœ¨${place.name}æ‰“å¡ï¼Œè·å¾—ä¸€æšæ–°å¾½ç« ï¼`;
            elements.newStampPreview.innerHTML = `
                <div class="w-20 h-20 rounded-full bg-primary/10 text-primary flex items-center justify-center text-4xl stamp-glow">
                    ${place.stamp}
                </div>
            `;
            elements.successModal.classList.remove('hidden');
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            const modalContent = elements.successModal.querySelector('div');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-300');
            }, 10);
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // åˆ·æ–°ä½ç½®
            elements.refreshLocation.addEventListener('click', function() {
                elements.locationInfo.classList.add('hidden');
                elements.locationStatus.classList.remove('hidden');
                elements.locationStatus.innerHTML = `
                    <i class="fa fa-spinner fa-spin mr-2"></i>
                    <span>æ­£åœ¨åˆ·æ–°ä½ç½®...</span>
                `;
                getUserLocation();
            });
            
            // æ‰“å¡æŒ‰é’®
            elements.checkInBtn.addEventListener('click', function() {
                const placeId = parseInt(this.dataset.placeId);
                if (placeId) {
                    checkInPlace(placeId);
                }
            });
            
            // å…³é—­æˆåŠŸå¼¹çª—
            elements.closeSuccessModal.addEventListener('click', function() {
                const modalContent = elements.successModal.querySelector('div');
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-300');
                
                setTimeout(() => {
                    elements.successModal.classList.add('hidden');
                }, 300);
            });
            
            // å¸®åŠ©æŒ‰é’®
            elements.helpBtn.addEventListener('click', function() {
                elements.helpModal.classList.remove('hidden');
            });
            
            // å…³é—­å¸®åŠ©å¼¹çª—
            elements.closeHelpModal.addEventListener('click', function() {
                elements.helpModal.classList.add('hidden');
            });
            
            // ç‚¹å‡»å¸®åŠ©å¼¹çª—èƒŒæ™¯å…³é—­
            elements.helpModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    elements.helpModal.classList.add('hidden');
                }
            });
            
            // ç‚¹å‡»æˆåŠŸå¼¹çª—èƒŒæ™¯å…³é—­
            elements.successModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    const modalContent = elements.successModal.querySelector('div');
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-300');
                    
                    setTimeout(() => {
                        elements.successModal.classList.add('hidden');
                    }, 300);
                }
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
